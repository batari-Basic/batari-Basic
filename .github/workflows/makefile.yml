name: Makefile CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install WASI SDK
      uses: konsumer/install-wasi-sdk@v1
      with:
        version: "25"

    - name: Install dos2unix
      run: sudo apt-get install dos2unix
      
    - name: Set Version
      run: |
        if [ ${{ vars.VERSION_SUFFIX }} ]; then
          echo "-${{ vars.VERSION_SUFFIX }}-${{ github.run_number }}" >> release.dat
        else
          echo ".${{ github.run_number }}" >> release.dat
        fi
        sed -i ':a;N;$!ba;s/\n//g' release.dat
        cat release.dat
        echo "VERSION_STRING=$(cat release.dat)" >> $GITHUB_ENV

    - name: Install golang
      uses: actions/setup-go@v6
      with:
        go-version: '^1.21'

    - name: Contrib
      run: |
        cd contrib
        ./make_relocateBB.sh
        ./make_pxebin2ccelf.sh
        ./make_dasm_wasm.sh
        cd ..   

    - name: Make Packages
      run: ./makepackages.sh

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.VERSION_STRING }}.tar.gz
        path: packages/*-wasm.tar.gz

    - name: Upload zip Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.VERSION_STRING }}.zip
        path: packages/*-wasm.zip
